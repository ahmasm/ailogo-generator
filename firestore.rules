rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Jobs collection
    match /jobs/{jobId} {
      // Anyone can read their own jobs (by jobId)
      allow read: if true;

      // Validate style field
      function isValidStyle() {
        let style = request.resource.data.style;
        return style == null
            || style == 'no-style'
            || style == 'monogram'
            || style == 'abstract'
            || style == 'mascot';
      }

      // Only allow creating jobs with valid data
      allow create: if request.resource.data.status == 'processing'
                    && request.resource.data.prompt is string
                    && request.resource.data.prompt.size() > 0
                    && request.resource.data.prompt.size() <= 500
                    && isValidStyle()
                    && request.resource.data.imageUrl == null
                    && request.resource.data.errorMessage == null;

      // Updates are only allowed from Cloud Functions (admin SDK bypasses rules)
      allow update: if false;

      // No deletes allowed from client
      allow delete: if false;
    }

    // Health check collection (for testing)
    match /health/{docId} {
      allow read, write: if true;
    }
  }
}
